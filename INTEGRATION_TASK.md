Опросы (новые) · интеграция с CRM

Текущие доработки платформы и функций портала

Exported on 2025-10-22 14:08:16

Table of Contents

1 I. введение 3

2 II. особенности API 4

3 III. структура пакетов 5

# I. введение

опросы портала в рамках интеграции отправляют данные на API выбранной CRM-системы (из списка ранее подключенных)

для этого, CRM-система заранее согласует с порталом своё короткое название (для выпадающего списка), техническое имя (для внутренних целей идентификации) и URL-адрес приёмника API-запросов на стороне CRM (можно с доменом, можно статический IP)

по ИБ, лучше, конечно, установить ограничения: сервис приёмника лучше ограничить ЛВС и не выставлять наружу, дополнительно сервис может проверять IP-адресов портала, чтобы не принимать пакеты от сторонних систем

предоставляемый URL-адрес должен однозначно и предельно чисто идентифицировать приёмник в CRM-системе, например <https://some.domain-example.ru/some-path/some-endpoint-base> (без всяких query-параметров, которые могли бы помешать или создать всем сложости уже на старте), в хвост этого URL будут доклеиваться два метода (**postPoll** и **postAnswer**):

<https://some.domain-example.ru/some-path/some-endpoint-base/postPoll>  
<https://some.domain-example.ru/some-path/some-endpoint-base/postAnswer>

при изменениях IP адреса, или IP адреса закреплённого за доменом, необходимо своевременно уведомить портал для внесения корректировок в конфигурацию

на портал передаётся только один исходный базовый URL, который и регистрируется в системе, для примера выше это <https://some.domain-example.ru/some-path/some-endpoint-base>

# II. особенности API

API приёмника в CRM необходимо реализовть всего два метода:

- **postPoll** - регистрация/подключение нового опроса (реактивация старого)
- **postAnswer** - приходит пакет с данными об ответах, его надо сохранить в CRM

в момент вызова _postPoll_, если используется RBAC на стороне CRM-системы, то предварительно, надо удостовериться, что у пользователя с корпоративным email (в домене …@[hse.ru](http://hse.ru)) есть права на создание сущностей в CRM-системе; в качестве корпоративного email в пакете указывается email сотрудника, который в админке портала включает интеграцию в конкретной опросной формы; если проверка есть, а прав нет - выдаётся ошибка и интеграция не включается

обмен осуществляется отправкой _JSON_ пакета (content-type: application/json) методом _POST_ на CRM API, ответ от этого API также должен приходить в виде _JSON_ (content-type: application/json)

ответ от CRM считается верным, а запрос обработанным, если сервер вернул код 200 и JSON-пакет с полем is_successful: true и прочими данным, необходимыми для взаимодействия по этому методу (об этом далее)

обращаем внимание, что _postPoll_ может вызываться неоднократно, потому что на портале кто-то может выключить интеграцию в опросе, а затем снова включить, это не является ошибкой, но чтобы интеграция была подтверждена и включена на портале, CRM необходимо вернуть не ошибочный ответ (status 200, { is_successful: true, … })

при отправке ответов методом _postAnswer_ предусмотрены повторные отправки на некотором интервале с ростом задержек между попытками, через 5 неудачных попыток пакет помечается, как невозможный к доставке и хранится на портале (такие пакеты можно найти в дальнейшем, чтобы устранить проблему и повторно загрузить, провести по ним работу)

мы рекомендуем начать разработку приёмника (если это происходит с нуля), с создания логирующих моков (заглушек) - сделайте пару методов, которые будут отвечать { is_successful: true }, с кодом HTTP 200, журналируйте входящие пакеты, включите интеграцию на свою CRM-систему в опросе портала, далее, попробуйте отправлять ответы - смотрите записи в журнале, корректируйте реализацию API по своим потребностям

в пакет ответа включаются только поля с проставленными кодами полей: есть ряд типовых кодов, которые уже внесены в справочник подсказок, которые предлагают пользователю выбрать - это типовые поля, вроде ФИО, email, телефон и прочие

# III. структура пакетов

- **postPoll** - регистрация/реактивация опроса

для отладки процессов можете дать такой CURL-запрос на свою систему (примерно так это обращение и выглядит на практике от настоящего backend-сервиса опросов):

curl -v -k -X POST -H 'Content-type: application/json' '<https://some.domain-example.ru/some-path/some-endpoint-base/postPoll>' --data '{"poll_id":123,"poll_name":"Какой у вас вопрос по ОП","poll_language":"ru","employee_email": "<somebody@hse.ru>"}'

разбор входящего JSON:

{

&nbsp; "poll_id": 123, // ID опросной формы

&nbsp; "poll_name": "Какой у вас вопрос по ОП", // короткое название опросной формы

&nbsp; "poll_language": "ru", // код языка по справочнику ('ru' или 'en') если есть потребность в делении данных по языковым тегам (пока у опросов два языка поддерживается)

&nbsp; "employee_email": "<somebody@hse.ru>", // email сотрудника запросившего включение интеграции опроса с CRM, если потребуется предварительная проверка RBAC

&nbsp; … // игнорируйте прочие параметры, может приходить разное: user_id (ID персоны на портале, но вряд ли кому-то это интересно без глубокой интеграции с персонами), name - старое и то же самое, что poll_name, express_poll_id - устар., то же, что и poll_id …

}

успешный исходящий ответ HTTP 200 от CRM:

{

&nbsp; "status": "success",

&nbsp; "message": "Связанная опросная форма для ID 123 создана в CRM или уже существует",

&nbsp; "description": "Подробности …как-что…",

&nbsp; "poll_id": 123, // ID формы портала

&nbsp; "is_successful": **true**

}

неуспешный исходящий ответ HTTP отличный от 200, или 200 с подобным телом:

{

&nbsp; "status": "error",

&nbsp; "message": "Опросная форма с ID 123 не создана",

&nbsp; "description": "Недостаточно прав у пользователя <somebody@hse.ru> / Произошла иная ошибка …",

&nbsp; "poll_id": 123, // ID формы портала

&nbsp; "is_successful": **false** // выставите в false или не включайте этот ключ в пакет!

}

- **postAnswer** - передача ответа

для отладки процессов можете дать такой CURL-запрос на свою систему (примерно так это обращение и выглядит на практике от настоящего backend-сервиса опросов):

curl -v -k -X POST -H 'Content-type: application/json' '<https://some.domain-example.ru/some-path/some-endpoint-base/postAnswer>' --data '{"header_data":{"poll_id":123,"answer_id":345,"create_time":"2025-07-21T11:35:47.921Z","analytics":{"url":"<https://portal.hse.ru/polls/123.html","params":{"utm_source":"direct","utm_medium":"direct","utm_campaign":"direct","utm_term":"direct","utm_content":"direct"},"cookies":{"\_ym_uid":"456","\_ga":"GA1.2.789","tracking":"CJ890","rete_uid":"eff61c31-d123-4567-7890-2f0768a670cb","roistat_visit":"14214214"},"mailingListSubscription":true,"ip":"123.45.67.89","date":"2025-07-21> 14:35","timeZone":"Europe/Moscow"},"form_kind":2,"gid":null},"data":{"firstname":"моё имя","lastname":"моя фамилия","email":"<test@dev.null>"}}'

подробный разбор входящего JSON:

на корневом уровне два поля

- **header_data** - содержит базовые сведения об опросе, аналитику

- **data** - содержит поля из формы (коды полей соответствуют указанным в админке), формат полей соответствует выбранным типам: обязательно протестируйте свой приёмник на совместимость с типами, с которыми предполагается работа

пример далее:

{

&nbsp; "header_data" : { // корневой служебный раздел с описанием

&nbsp; "poll_id" : 123, // уникальный ID-опроса

&nbsp; "answer_id" : 345, // уникальный ID-ответа (в рамках опроса, но на портале все ID в основном уникальны и не повторяются, используется сквозной генератор числовой последовательности)

&nbsp; "form_kind" : 2, // вид формы (есть справочник, см. далее)

&nbsp; "gid" : **null**, // сквозной ID группы контактов (если заполнено в админке), просто какой-то общий идентификатор, имеющий значений для внутренней группировки в CRM, например, можно по разным формам его прописать, но считать их одной группой

&nbsp; "create_time" : "2025-07-21T11:35:47.921Z", // дата ответа

&nbsp; "analytics" : { // аналитика, которую удалось собрать

&nbsp; "cookies" : { // полезные для аналитики куки

&nbsp; "tracking" : "CJ890", // это сам портал вешает клиентам

&nbsp; "\_ga" : "GA1.2.789",

&nbsp; "\_ym_uid" : "456",

&nbsp; "rete*uid" : "eff61c31-d123-4567-7890-2f0768a670cb", // из rete_user-id*.hse.ru

&nbsp; "roistat_visit" : "14214214", // из roistat_visit

&nbsp; … // + ещё может с сайтов ДПО забирать сюда коллекцию ключей-значений из rete*rete_marketing_session_3_last_utm*.hse.ru

&nbsp; },

&nbsp; "date" : "2025-07-21 14:35", // дата отправки ответа

&nbsp; "ip" : "123.45.67.89", // IP адрес посетителя

&nbsp; "mailingListSubscription" : **true**, // дал ли разрешение на рассылку рекламных материалов

&nbsp; "params" : { // собранные utm-параметры

&nbsp; "utm_campaign" : "direct",

&nbsp; "utm_content" : "direct",

&nbsp; "utm_medium" : "direct",

&nbsp; "utm_source" : "direct",

&nbsp; "utm_term" : "direct",

&nbsp; … // + могут быть ещё некоторые редкие, кроме них gclid, yclid, fbclid (если будут обнаружены)

&nbsp; },

&nbsp; "timeZone" : "Europe/Moscow", // системный часовой пояс

&nbsp; "url" : "<https://portal.hse.ru/polls/123.html>" // на какой странице ответил на опрос (опрос может быть доступен по разным адресам и в поповерах)

&nbsp; }

&nbsp; }

&nbsp; ,

&nbsp; "data" : { // корневой раздел данных ответа от формы опроса (состав зависит от полей в конструкторе опроса, коды полей задаются в опросе, формат данных зависит от настроек конкретного вопроса), разбор данных, их формата лучше строить исходя из заранее предусмотренных кодов расставляемых у полей формы; страны передаются с кодами из справочника, если каких-то стран/кодов нет - их надо на портале вносить

&nbsp; "email" : "<test@dev.null>",

&nbsp; "firstname" : "моё имя",

&nbsp; "lastname" : "моя фамилия",

&nbsp; … // + прочие поля из формы с проставленными кодами

&nbsp; }

}

вид формы **form_kind** может принимать значения:

- null - не указано
- 1 - консультация
- 2 - регистрация

успешный исходящий ответ HTTP 200 от CRM:

{

&nbsp; "status": "success",

&nbsp; "message": "Ответ 345 успешно сохранён в CRM или был зарегистрирован ранее",

&nbsp; "description": "Подробности …как-что если надо…",

&nbsp; "poll_id": 123, // ID формы портала

&nbsp; "answer_id": 345, // ID ответа

&nbsp; "is_successful": **true** // в принципе, достаточно только этого поля для корректной работы

}

неуспешный исходящий ответ HTTP отличный от 200, или 200 с подобным телом:

{

&nbsp; "status": "error",

&nbsp; "message": "Не удалось сохранить ответ 345",

&nbsp; "description": "Произошла ошибка …описание почему и что рекомендуется делать…",

&nbsp; "poll_id": 123, // ID формы портала

&nbsp; "answer_id": 345, // ID ответа

&nbsp; "is_successful": **false** // выставите в false или не включайте этот ключ в пакет!

}
