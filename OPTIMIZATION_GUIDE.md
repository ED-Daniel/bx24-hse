# ‚ö° –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ CRM Integration Service

–≠—Ç–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏, —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Bitrix24.

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ](#–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ)
2. [Batch –æ–ø–µ—Ä–∞—Ü–∏–∏](#batch-–æ–ø–µ—Ä–∞—Ü–∏–∏)
3. [Retry –ª–æ–≥–∏–∫–∞](#retry-–ª–æ–≥–∏–∫–∞)
4. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
5. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-–∏-–æ—Ç–ª–∞–¥–∫–∞)

---

## üóÑÔ∏è –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ß—Ç–æ –∫–µ—à–∏—Ä—É–µ—Ç—Å—è

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–µ—à–∏—Ä—É–µ—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–¥–∫–æ –º–µ–Ω—è—é—Ç—Å—è:

| –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö | TTL –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è |
|-----------|------------------|---------------------|
| –û–ø—Ä–æ—Å–Ω—ã–µ —Ñ–æ—Ä–º—ã | 10 –º–∏–Ω—É—Ç (600s) | `CACHE_TTL_POLL_FORMS` |
| –û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã | 10 –º–∏–Ω—É—Ç (600s) | `CACHE_TTL_EDUCATIONAL_PROGRAMS` |
| –ö–æ–Ω—Ç–∞–∫—Ç—ã | 5 –º–∏–Ω—É—Ç (300s) | `CACHE_TTL_CONTACTS` |
| –°–¥–µ–ª–∫–∏ | 1 –º–∏–Ω—É—Ç–∞ (60s) | `CACHE_TTL_DEALS` |

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

```python
# –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ - –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ Bitrix24 API
poll_form = service.find_poll_form(430131691)
# API –∑–∞–ø—Ä–æ—Å –∫ Bitrix24 ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–µ—à–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 10 –º–∏–Ω—É—Ç

# –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤ —Ç–µ—á–µ–Ω–∏–µ 10 –º–∏–Ω—É—Ç - –∏–∑ –∫–µ—à–∞
poll_form = service.find_poll_form(430131691)
# –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∏–∑ –∫–µ—à–∞ ‚Üí API –∑–∞–ø—Ä–æ—Å –ù–ï –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ **–°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Bitrix24 API**
- –ú–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ = –º–µ–Ω—å—à–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è rate limits
- –≠–∫–æ–Ω–æ–º–∏—è –Ω–∞ API –∫–≤–æ—Ç–∞—Ö (–µ—Å–ª–∏ –µ—Å—Ç—å)

‚úÖ **–£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏**
- –ö–µ—à –æ—Ç–≤–µ—á–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ (< 1ms)
- API –∑–∞–ø—Ä–æ—Å –∑–∞–Ω–∏–º–∞–µ—Ç 100-500ms

‚úÖ **–ü–æ–≤—ã—à–µ–Ω–∏–µ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏**
- –ï—Å–ª–∏ Bitrix24 –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∫–µ—à –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- –°–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –æ—à–∏–±–æ–∫ –∏–∑-–∑–∞ network issues

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è

–í `.env` —Ñ–∞–π–ª–µ:

```env
# –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∫–µ—à
CACHE_ENABLED=True

# TTL –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
CACHE_TTL_POLL_FORMS=600           # 10 –º–∏–Ω—É—Ç
CACHE_TTL_EDUCATIONAL_PROGRAMS=600 # 10 –º–∏–Ω—É—Ç
CACHE_TTL_CONTACTS=300             # 5 –º–∏–Ω—É—Ç
CACHE_TTL_DEALS=60                 # 1 –º–∏–Ω—É—Ç–∞
```

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ TTL

| –°—Ü–µ–Ω–∞—Ä–∏–π | –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π TTL | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|----------|-------------------|-------------|
| **Production (—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏)** | 1800s (30 –º–∏–Ω) | –û–ø—Ä–æ—Å–Ω—ã–µ —Ñ–æ—Ä–º—ã –∏ –û–ü —Ä–µ–¥–∫–æ –º–µ–Ω—è—é—Ç—Å—è |
| **Development** | 300s (5 –º–∏–Ω) | –ß–∞—Å—Ç—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö |
| **High-load —Å–∏—Å—Ç–µ–º–∞** | 3600s (1 —á–∞—Å) | –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API |
| **Real-time —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è** | 60s (1 –º–∏–Ω) | –î–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ |

### –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–µ—à–∞

–ö–µ—à –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ TTL. –î–ª—è —Ä—É—á–Ω–æ–π –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏:

```python
from app.utils.cache import cache_manager

# –ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –æ–ø—Ä–æ—Å–Ω—É—é —Ñ–æ—Ä–º—É
cache_manager.invalidate("poll_form", poll_id=430131691)

# –ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ–ø—Ä–æ—Å–Ω—ã–µ —Ñ–æ—Ä–º—ã
cache_manager.invalidate("poll_form")

# –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫–µ—à
cache_manager.clear()

# –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–µ—à–∞
stats = cache_manager.stats()
print(stats)
# {'total_entries': 15, 'categories': {'poll_form': 5, 'educational_program': 10}}
```

### –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Redis (–¥–ª—è production)

–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç in-memory –∫–µ—à. –î–ª—è production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è Redis:

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Redis:
```bash
pip install redis
```

2. –û–±–Ω–æ–≤–∏—Ç—å `app/utils/cache.py`:
```python
import redis

class RedisCacheManager:
    def __init__(self):
        self.redis = redis.Redis(
            host=settings.REDIS_HOST,
            port=settings.REDIS_PORT,
            db=0
        )
```

3. –î–æ–±–∞–≤–∏—Ç—å –≤ `.env`:
```env
REDIS_HOST=localhost
REDIS_PORT=6379
```

---

## üöÄ Batch –æ–ø–µ—Ä–∞—Ü–∏–∏

### –ß—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ

Batch API –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å **–¥–æ 50 –∫–æ–º–∞–Ω–¥ –∑–∞ –æ–¥–∏–Ω HTTP –∑–∞–ø—Ä–æ—Å** –∫ Bitrix24.

### –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

**–ü–æ–∏—Å–∫ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º:**

–í–º–µ—Å—Ç–æ N –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è N –ø—Ä–æ–≥—Ä–∞–º–º ‚Üí 1 batch –∑–∞–ø—Ä–æ—Å:

```python
# –ë–ï–ó batch (–º–µ–¥–ª–µ–Ω–Ω–æ):
# Request 1: GET educational_program "–¶–∏—Ñ—Ä–æ–≤–æ–π —é—Ä–∏—Å—Ç"  ‚Üí 150ms
# Request 2: GET educational_program "–ê–Ω—Ç–∏—á–Ω–æ—Å—Ç—å"     ‚Üí 150ms
# Request 3: GET educational_program "–≠–∫–æ–Ω–æ–º–∏–∫–∞"      ‚Üí 150ms
# –ò—Ç–æ–≥–æ: 450ms

# –° batch (–±—ã—Å—Ç—Ä–æ):
# Request 1: BATCH [program1, program2, program3]     ‚Üí 200ms
# –ò—Ç–æ–≥–æ: 200ms (—ç–∫–æ–Ω–æ–º–∏—è 250ms)
```

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç batch –µ—Å–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º > 1
programs = service.find_educational_programs([
    "–¶–∏—Ñ—Ä–æ–≤–æ–π —é—Ä–∏—Å—Ç",
    "–ê–Ω—Ç–∏—á–Ω–æ—Å—Ç—å",
    "–≠–∫–æ–Ω–æ–º–∏–∫–∞"
])
# ‚Üí –û–¥–∏–Ω batch –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ —Ç—Ä–µ—Ö –æ—Ç–¥–µ–ª—å–Ω—ã—Ö
```

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞** - —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –≤—Å–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –≤ –∫–µ—à–µ
2. **Batch –∑–∞–ø—Ä–æ—Å** - –¥–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤ –∫–µ—à–µ (–µ—Å–ª–∏ –∏—Ö > 1)
3. **Fallback** - –µ—Å–ª–∏ batch –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∏–ª–∏ –æ—à–∏–±–∫–∞ ‚Üí –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
4. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∫–µ—à–∏—Ä—É—é—Ç—Å—è

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞

–í `.env`:

```env
# –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å batch –æ–ø–µ—Ä–∞—Ü–∏–∏
BATCH_ENABLED=True

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä batch (Bitrix24 –ª–∏–º–∏—Ç = 50)
BATCH_SIZE=50
```

### –ö–æ–≥–¥–∞ batch –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

- –ï—Å–ª–∏ `BATCH_ENABLED=False`
- –ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º <= 1 (–Ω–µ—Ç —Å–º—ã—Å–ª–∞)
- –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —É–∂–µ –≤ –∫–µ—à–µ

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≥—Ä–∞–º–º | –ë–µ–∑ batch | –° batch | –≠–∫–æ–Ω–æ–º–∏—è |
|-------------------|-----------|---------|----------|
| 1 | 150ms | 150ms | 0ms |
| 2 | 300ms | 200ms | 100ms |
| 5 | 750ms | 250ms | 500ms |
| 10 | 1500ms | 300ms | 1200ms |

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–≤–æ–∏—Ö batch –æ–ø–µ—Ä–∞—Ü–∏–π

```python
# –í bitrix24_client.py
commands = {
    "get_contact": {
        "method": "crm.contact.get",
        "params": {"id": 123}
    },
    "get_deal": {
        "method": "crm.deal.get",
        "params": {"id": 456}
    }
}

result = client.batch(commands)

contact = result["result"]["result"]["get_contact"]
deal = result["result"]["result"]["get_deal"]
```

---

## üîÑ Retry –ª–æ–≥–∏–∫–∞

### –ß—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–≤—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö —Å–µ—Ç–∏.

### –ö–∞–∫–∏–µ –æ—à–∏–±–∫–∏ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è

‚úÖ **–ü–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è:**
- `ConnectionError` - –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é
- `TimeoutError` - –ø—Ä–µ–≤—ã—à–µ–Ω —Ç–∞–π–º–∞—É—Ç
- `HTTP 500-504` - server errors –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Bitrix24

‚ùå **–ù–ï –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è:**
- `HTTP 400-499` - client errors (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å)
- `Exception` - –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ –∫–æ–¥–µ

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ–≤—Ç–æ—Ä–æ–≤

**Exponential backoff** - –∑–∞–¥–µ—Ä–∂–∫–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–æ–π:

```
–ü–æ–ø—ã—Ç–∫–∞ 1: –°—Ä–∞–∑—É
–ü–æ–ø—ã—Ç–∫–∞ 2: –ó–∞–¥–µ—Ä–∂–∫–∞ 1s   (BITRIX24_RETRY_DELAY)
–ü–æ–ø—ã—Ç–∫–∞ 3: –ó–∞–¥–µ—Ä–∂–∫–∞ 2s   (1s √ó 2.0)
–ü–æ–ø—ã—Ç–∫–∞ 4: –ó–∞–¥–µ—Ä–∂–∫–∞ 4s   (2s √ó 2.0)
–ü–æ–ø—ã—Ç–∫–∞ 5: –ó–∞–¥–µ—Ä–∂–∫–∞ 8s   (4s √ó 2.0)
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞

–í `.env`:

```env
# –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫
BITRIX24_RETRY_MAX_ATTEMPTS=3

# –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (—Å–µ–∫—É–Ω–¥—ã)
BITRIX24_RETRY_DELAY=1.0

# –ú–Ω–æ–∂–∏—Ç–µ–ª—å —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏
BITRIX24_RETRY_BACKOFF=2.0
```

### –ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

**–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ retry (–¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π):**
```env
BITRIX24_RETRY_MAX_ATTEMPTS=5
BITRIX24_RETRY_DELAY=2.0
BITRIX24_RETRY_BACKOFF=1.5
```

**–ë—ã—Å—Ç—Ä—ã–µ retry (–¥–ª—è real-time):**
```env
BITRIX24_RETRY_MAX_ATTEMPTS=2
BITRIX24_RETRY_DELAY=0.5
BITRIX24_RETRY_BACKOFF=2.0
```

**–û—Ç–∫–ª—é—á–∏—Ç—å retry:**
```env
BITRIX24_RETRY_MAX_ATTEMPTS=1
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ retry

–í—Å–µ retry –ø–æ–ø—ã—Ç–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:

```
‚ö†Ô∏è _make_request –ø–æ–ø—ã—Ç–∫–∞ 1/3 –ø—Ä–æ–≤–∞–ª–µ–Ω–∞: Connection timeout. –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 1.0s...
‚ö†Ô∏è _make_request –ø–æ–ø—ã—Ç–∫–∞ 2/3 –ø—Ä–æ–≤–∞–ª–µ–Ω–∞: HTTP 503. –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 2.0s...
‚úÖ _make_request —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —Å –ø–æ–ø—ã—Ç–∫–∏ 3/3
```

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

```python
@retry_on_network_error(max_attempts=3, delay=1.0)
def _make_request(self, method, params):
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ network errors
    response = self.client.post(url, json=params)
    return response.json()
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è Production

#### 1. –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–µ—à–∞

```env
# –î–æ–ª–≥–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤
CACHE_TTL_POLL_FORMS=1800          # 30 –º–∏–Ω—É—Ç
CACHE_TTL_EDUCATIONAL_PROGRAMS=1800 # 30 –º–∏–Ω—É—Ç

# –ö–æ—Ä–æ—Ç–∫–æ–µ –¥–ª—è —á–∞—Å—Ç–æ –º–µ–Ω—è—é—â–∏—Ö—Å—è –¥–∞–Ω–Ω—ã—Ö
CACHE_TTL_CONTACTS=300             # 5 –º–∏–Ω—É—Ç
CACHE_TTL_DEALS=60                 # 1 –º–∏–Ω—É—Ç–∞
```

#### 2. –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ retry

```env
BITRIX24_RETRY_MAX_ATTEMPTS=5
BITRIX24_RETRY_DELAY=2.0
BITRIX24_RETRY_BACKOFF=1.5
```

#### 3. Batch –æ–ø–µ—Ä–∞—Ü–∏–∏

```env
BATCH_ENABLED=True
BATCH_SIZE=50
```

#### 4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```env
# WARNING —É—Ä–æ–≤–µ–Ω—å –¥–ª—è production (–º–µ–Ω—å—à–µ –ª–æ–≥–æ–≤)
LOG_LEVEL=WARNING
```

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è Development

```env
# –ö–æ—Ä–æ—Ç–∫–∏–π –∫–µ—à –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
CACHE_TTL_POLL_FORMS=300
CACHE_TTL_EDUCATIONAL_PROGRAMS=300

# –ú–µ–Ω—å—à–µ retry –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ—Ç–ª–∞–¥–∫–∏
BITRIX24_RETRY_MAX_ATTEMPTS=2

# DEBUG –ª–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
LOG_LEVEL=DEBUG
```

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:
```
–û–±—Ä–∞–±–æ—Ç–∫–∞ webhook —Å 3 –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞–º–∏:
- 3 –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–∏—Å–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º: 450ms
- –°–æ–∑–¥–∞–Ω–∏–µ 3 —Å–¥–µ–ª–æ–∫: 600ms
- –û–±–æ–≥–∞—â–µ–Ω–∏–µ 3 —Å–¥–µ–ª–æ–∫: 600ms
–ò—Ç–æ–≥–æ: ~1650ms
```

#### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π (—Å –∫–µ—à–µ–º –∏ batch):
```
–û–±—Ä–∞–±–æ—Ç–∫–∞ webhook —Å 3 –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞–º–∏:
- 1 batch –∑–∞–ø—Ä–æ—Å (–ø–µ—Ä–≤—ã–π —Ä–∞–∑): 200ms
- 0 –∑–∞–ø—Ä–æ—Å–æ–≤ (–≤—Ç–æ—Ä–æ–π —Ä–∞–∑, –∫–µ—à): 0ms
- –°–æ–∑–¥–∞–Ω–∏–µ 3 —Å–¥–µ–ª–æ–∫: 600ms
- –û–±–æ–≥–∞—â–µ–Ω–∏–µ 3 —Å–¥–µ–ª–æ–∫: 600ms
–ò—Ç–æ–≥–æ: 1400ms (–ø–µ—Ä–≤—ã–π —Ä–∞–∑), 1200ms (–ø–æ—Å–ª–µ–¥—É—é—â–∏–µ)
–≠–∫–æ–Ω–æ–º–∏—è: 15-30%
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞

```python
from app.utils.cache import cache_manager

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–µ—à–∞
stats = cache_manager.stats()
print(f"–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π –≤ –∫–µ—à–µ: {stats['total_entries']}")
print(f"–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º: {stats['categories']}")

# –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞
cache_manager.clear()
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Health endpoint

```bash
curl http://localhost:8000/api/v1/integration/health
```

Response:
```json
{
  "status": "healthy",
  "cache_stats": {
    "total_entries": 15,
    "categories": {
      "poll_form": 5,
      "educational_program": 10
    }
  }
}
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–í–∫–ª—é—á–∏—Ç–µ DEBUG –ª–æ–≥–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

```env
LOG_LEVEL=DEBUG
```

–í—ã —É–≤–∏–¥–∏—Ç–µ:
```
Cache HIT: educational_program:–¶–∏—Ñ—Ä–æ–≤–æ–π —é—Ä–∏—Å—Ç
Cache MISS: educational_program:–ù–æ–≤–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞
Using batch request for 3 programs
‚ö†Ô∏è _make_request –ø–æ–ø—ã—Ç–∫–∞ 1/3 –ø—Ä–æ–≤–∞–ª–µ–Ω–∞: Connection timeout
‚úÖ _make_request —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —Å –ø–æ–ø—ã—Ç–∫–∏ 2/3
```

### –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–ª–∞–¥–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É, –æ—Ç–∫–ª—é—á–∏—Ç–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

```env
# –û—Ç–∫–ª—é—á–∏—Ç—å –≤—Å–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
CACHE_ENABLED=False
BATCH_ENABLED=False
BITRIX24_RETRY_MAX_ATTEMPTS=1
LOG_LEVEL=DEBUG
```

---

## üéØ –ß–µ–∫–ª–∏—Å—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (–≥–æ—Ç–æ–≤–æ –∏–∑ –∫–æ—Ä–æ–±–∫–∏)

- [x] ‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ –≤–∫–ª—é—á–µ–Ω–æ
- [x] ‚úÖ Batch –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–∫–ª—é—á–µ–Ω—ã
- [x] ‚úÖ Retry –ª–æ–≥–∏–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
- [x] ‚úÖ –†–∞–∑—É–º–Ω—ã–µ TTL –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

### –î–ª—è Production

- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å TTL –ø–æ–¥ —Å–≤–æ–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- [ ] –£–≤–µ–ª–∏—á–∏—Ç—å BITRIX24_RETRY_MAX_ATTEMPTS –¥–æ 5
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å LOG_LEVEL=WARNING
- [ ] –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Redis –¥–ª—è –∫–µ—à–∞
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫

### –î–ª—è High-Load

- [ ] –£–≤–µ–ª–∏—á–∏—Ç—å CACHE_TTL –¥–æ 30-60 –º–∏–Ω—É—Ç
- [ ] –í–∫–ª—é—á–∏—Ç—å connection pooling –¥–ª—è –ë–î
- [ ] –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å horizontal scaling (–Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Load Balancer

---

## üìù –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫

| –ü–∞—Ä–∞–º–µ—Ç—Ä | Development | Production | High-Load |
|----------|-------------|-----------|-----------|
| `CACHE_ENABLED` | True | True | True |
| `CACHE_TTL_POLL_FORMS` | 300s | 1800s | 3600s |
| `CACHE_TTL_EDUCATIONAL_PROGRAMS` | 300s | 1800s | 3600s |
| `BATCH_ENABLED` | True | True | True |
| `BITRIX24_RETRY_MAX_ATTEMPTS` | 2 | 5 | 5 |
| `BITRIX24_RETRY_DELAY` | 1.0 | 2.0 | 2.0 |
| `LOG_LEVEL` | DEBUG | WARNING | ERROR |

---

**–í–µ—Ä—Å–∏—è:** 1.0
**–î–∞—Ç–∞:** 2025-10-23
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Production Ready
